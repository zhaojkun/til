# Makefile 变量与宏

### 变量的用途，类型

make包含了两种语言：

* 第一种用来描述工作目标与必要条件所组成的依存图

* 第二种语言是宏语言，用来进行文字替换。宏变量会被“就地”展开，其所产生的文本字符串还可以进一步的扩展。变量是大小写区分的。要取得某个变量的值，请用`$()`括住该变量的名称

一个变量的值由赋值符号右边已删除前导空格的所有字组成。跟在所有字之后的空格则不会被删除

变量可以用来保存简单的常数，也可用来存放用户自定义的命令序列。

make的变量有两种类型：经简单扩展的变量以及经递归扩展的变量。

可以用`:=`赋值运算符来定义一个经简单扩展的变量。如：

```shell
MAKE_DEPEND:=$(CC) -M
```

之所以称此变量为“经简单扩展”是因为：一旦make从makefile读进该变量的定义语句，赋值运算符的右边会立刻被扩展。赋值运算符的右边部分只要出现make变量的引用就会被扩展，而扩展后所产生的文本则会被存储城该变量的值。

第二种变量类型称为经递归扩展的变量。可以用`=`赋值运算符来定义一个经递归扩展的变量（或称递归变量）。之所以称此变量为“经递归扩展”是因为，make只会读进赋值运算符右边的部分，并将之存储城该变量的值，并不会进行任何扩展的动作，扩展的动作会被延迟到该变量被使用的时候才进行。将此变量成为延后扩展的变量。

事实上，对递归变量所进行的并非真的是延后赋值的动作。每当递归变量被使用时，make就会对它的右边部分进行重新求值动作。

其他赋值类型：

* `?=`运算符成为附带条件的变量赋值运算符，简称为条件赋值。此运算符只会在变量的值尚不存在的情况下进行变量要求的赋值动作。这个功能可以跟环境变量有很好的交互。
* `+=`运算符通常成为附加运算符。此运算符会将文本附加到变量里。`+?`被特别实现城可将文本附加到递归变量中并做正确的事。此运算符对于想将所收集到的值递增给变量的人来说特别有用。

在GNU make中，我们可以通过`define`指令以创建“封装命令序列”的方式来解决命令太长的问题。“封装命令序列”即为宏。在make中，宏只是用来定义变量的另一种方式。此变量还可以包含内置的换行符号，如：

```shell
define create-jar
	@echo Creating $@...
	$(RM) $(TMP_JAR_DIR)
	$(MKDIR) $(TMP_JAR_DIR)
	$(CP) -r $^ $(TMP_JAR_DIR)
	cd $(TMP_JAR_DIR) && $(JAR) $(JARFLAGS) $@ .
	$(JAR) -ufm $@ $(MANIFEST)
	$(RM) $(TMP_JAR_DIR)
endef
```

define指令后边跟着变量名以及一个换行符。变量的主题包含了所有的命令序列（每一行命令必须前置一个跳格符）直到endef关键字出现位置。

当make运行时，它会以两个阶段来完成它的工作。第一个阶段，make会读进makefile以及被引入的任何其他makefile。这个时候，其中所有定义的变量和规则会被加载进make的内部数据库，而且依存图也会被建立起来。第二个阶段，make会分析依存图并且判断需要更新的工作目标，然后执行脚本以完成所需要的更新动作。

当make在处理递归变量或define指令的时候，会将变量里的每一行或行的主体存储起来，包括换行符号，但不会予以扩展。宏定义里的最后一个换行符号并不会被存储成宏的一部分。当宏被扩展时，make会立即扫描被扩展的文本中是否存在宏或变量的引用，如果存在就予以扩展，如此递归进行下去。如果宏是在命令脚本的语境中被扩展，则宏主体的每一行都会被插入一个前导跳格符

### 变量来自何处

make的变量可以有以下几个来源：

* 文件
  当然，变量可以被定义在makefile中，或是被makefile引入（inlcude指令）

* 命令行

  可以直接在make命令行上定义或重新定义变量：

  ```shell
  make CFLAGS=-G CPPFLAGS="-DBSD -DDEBUG"
  ```

* 环境
  当make启动时，所有来自环境的变量都会被自动定义成make的变量。这些变量具有非常低的优先级，所以makefile文件或命令行参数的赋值结果将会覆盖掉环境变量的值。

* 自动创建

  最后，make会在执行一个规则的命令脚本之前立刻创建自动变量

### 条件指令与引入指令的处理

条件指令的基本语法如下：

```shell
if-condition
	text if the condition is true
endif
或
if-condition
	text if the condition is true
else
	text if the condition is false
endif
```

`if-condition`可以是以下之一：

* `ifdef variable-name`

* `ifndef variable-name`

* `ifeq test`

* `ifneq test`

  最后 `test`可以表示成下面的形式：

  `"a" "b"`或：`(a,b)` 其中单引号或双引号可以交替使用

条件处理指令可用在宏定义和命令脚本中，还可以放在makefile的顶层

一个makefile可以引入其他文件，此功能常用来引入make头文件中所存放的共同的make的定义，或是用来自动产生已存关系的信息。

make可以把makefile本身作为一个可能的工作目标。
